{{ define "content.html" }}
<div id="messages-content" class="flex w-4/5 max-w-full flex-auto flex-col lg:flex-row mx-auto h-[80vh]">
    <!-- Leads -->
    <div class="w-full flex-none flex-col p-4 lg:flex lg:w-80 lg:p-8 xl:w-96 h-full">
        <div
            class="flex flex-auto flex-col items-center justify-start rounded-xl border-2 border-dashed border-gray-200 bg-gray-50 py-4 text-gray-400 dark:border-gray-700 dark:bg-gray-800 overflow-y-auto h-full">
            <ul class="overflow-auto w-full flex flex-col" role="listbox">
                {{ range .Messages }}
                <li data-lead-id="{{ .LeadID }}"
                    class="clientName group flex cursor-pointer items-center justify-between gap-2 px-3 text-sm text-gray-600 hover:text-gray-950 dark:text-gray-300 dark:hover:text-white"
                    role="option" tabindex="-1" aria-selected="false">
                    <div class="grow truncate py-1.5">{{ .ClientName }}</div>
                    <div id="icons" class="flex items-center gap-4">
                        {{ if gt .UnreadMessages 0 }}
                        <span
                            class="inline-flex rounded-full border border-primary-200 bg-primary-100 px-1.5 py-0.5 text-xs font-semibold leading-4 text-primary-700 dark:border-primary-700 dark:bg-primary-700 dark:text-primary-50">
                            {{ .UnreadMessages }}
                        </span>
                        {{ end }}
                        <a href="/crm/lead/{{ .LeadID }}" target="_blank">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="hi-micro hi-user-circle inline-block size-5">
                                <path fill-rule="evenodd" d="M15 8A7 7 0 1 1 1 8a7 7 0 0 1 14 0Zm-5-2a2 2 0 1 1-4 0 2 2 0 0 1 4 0ZM8 9c-1.825 0-3.422.977-4.295 2.437A5.49 5.49 0 0 0 8 13.5a5.49 5.49 0 0 0 4.294-2.063A4.997 4.997 0 0 0 8 9Z" clip-rule="evenodd"/>
                            </svg>
                        </a>
                        <svg data-lead-id="{{ .LeadID }}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"
                            class="archiveLead hi-micro hi-x-circle inline-block size-5">
                            <path fill-rule="evenodd"
                                d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14Zm2.78-4.22a.75.75 0 0 1-1.06 0L8 9.06l-1.72 1.72a.75.75 0 1 1-1.06-1.06L6.94 8 5.22 6.28a.75.75 0 0 1 1.06-1.06L8 6.94l1.72-1.72a.75.75 0 1 1 1.06 1.06L9.06 8l1.72 1.72a.75.75 0 0 1 0 1.06Z"
                                clip-rule="evenodd" />
                        </svg>
                    </div>
                </li>
                {{ end }}
            </ul>
        </div>
    </div>
    <!-- END Leads -->

    <!-- Messages -->
    <div class="mx-auto flex w-full flex-col p-4 lg:p-8 h-full">
        <div
            class="flex flex-auto overflow-y-auto items-center justify-center rounded-xl border-2 border-dashed border-gray-200 bg-gray-50 text-gray-400 dark:border-gray-700 dark:bg-gray-800">
            <div id="messages" class="mx-auto max-w-2xl space-y-4 lg:space-y-8">
                Messages
            </div>
        </div>
    </div>
    <!-- END Messages -->
</div>

<div id="alertModal"></div>

<input type="hidden" name="csrf_token" value="{{ .CSRFToken }}" />

<script nonce="{{ .Nonce }}">
    const isVisiblePercentageThreshold = 0.75;
    const messageQueue = [];
    let isProcessing = false;

    function processQueue() {
        if (isProcessing || messageQueue.length === 0) return;

        isProcessing = true;
        const message = messageQueue.shift();

        handleMarkMessageAsRead(message)
            .catch(console.error)
            .finally(() => {
                isProcessing = false;
                processQueue();
            });
    }

    function enqueueMessage(message) {
        if (!messageQueue.includes(message)) {
            messageQueue.push(message);
            processQueue();
        }
    }

    function handleMarkMessageAsRead(message) {
        return new Promise((resolve, reject) => {
            if (message.dataset.isRead === "true") return resolve();

            const messageId = message.dataset.messageId;
            const leadId = message.dataset.leadId;
            const csrfToken = document.querySelector('[name="csrf_token"]');

            const body = new FormData();
            body.set("message_id", messageId);
            body.set("lead_id", leadId);
            body.set("csrf_token", csrfToken.value);
            body.set("is_read", "true");

            fetch(`/crm/message/${messageId}/read`, {
                method: "PUT",
                credentials: "include",
                body: body
            })
                .then(response => {
                    const token = response.headers.get('X-Csrf-Token');
                    if (token) {
                        document.querySelectorAll('[name="csrf_token"]').forEach(csrf_token => csrf_token.value = token);
                    }
                    if (!response.ok) {
                        return response.text().then(err => reject(new Error(err)));
                    }
                    return response.text();
                })
                .then(html => {
                    messages.innerHTML = html;
                    handleBindMessageActions();
                    resolve();
                })
                .catch(err => {
                    alertModal.outerHTML = err.message;
                    reject(err);
                })
                .finally(() => handleCloseAlertModal());
        });
    }

    function handleBindMessageActions() {
        // Mark as read on seen
        const messagesList = document.querySelectorAll(".messageContent");

        if (!messagesList.length) return;

        const observer = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    enqueueMessage(entry.target);
                }
            });
        }, { threshold: isVisiblePercentageThreshold });

        messagesList.forEach(message => observer.observe(message));

        // Archive leads
        const archiveButtons = document.querySelectorAll(".archiveLead");

		archiveButtons.forEach(btn => {
			btn.addEventListener("click", () => {
				handleArchiveLead(btn.dataset.leadId);
			});
		});
    }

    document.addEventListener("DOMContentLoaded", () => handleBindMessageActions());

	function handleArchiveLead(leadId) {
		const alertModal = document.getElementById("alertModal");

		const data = new FormData();
		const csrfToken = document.querySelector('[name="csrf_token"]');
		if (csrfToken) {
			data.set("csrf_token", csrfToken.value);
		}

		fetch(`/crm/lead/${leadId}/archive`, {
			method: "PUT",
			credentials: "include",
			body: data
		})
			.then((response) => {
				const token = response.headers.get('X-Csrf-Token');
				if (token) {
					const tokens = document.querySelectorAll('[name="csrf_token"]');
					tokens.forEach(csrf_token => csrf_token.value = token);
				}
				if (response.ok) {
					return response.text();
				} else {
					return response.text().then((err) => {
						throw new Error(err);
					});
				}
			})
			.then(html => {
				const table = document.getElementById('leadsTable');
				table.outerHTML = html;
				handleBindMessageActions();
			})
			.catch(err => {
				alertModal.outerHTML = err.message;
			})
			.finally(() => handleCloseAlertModal());
	}
</script>

<script nonce="{{ .Nonce }}">
    const clients = document.querySelectorAll(".clientName");
    const messages = document.getElementById("messages");

    function handleGetClientMessages(leadId) {
        fetch(`/crm/message/${leadId}`, {
            method: "GET",
            credentials: "include",
        })
            .then((response) => {
                if (response.ok) {
                    return response.text();
                } else {
                    return response.text().then((err) => {
                        throw new Error(err);
                    });
                }
            })
            .then(html => {
                messages.innerHTML = html;
                handleBindMessageActions();
            })
            .catch(console.error);
    };

    clients.forEach(client => {
        const leadId = client.dataset.leadId;
        client.addEventListener("click", (e) => handleGetClientMessages(leadId));
    });
</script>

<script src="{{ .StaticPath }}/main.js" nonce="{{ .Nonce }}"></script>
{{ end }}